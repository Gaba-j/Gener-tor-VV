<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generátor protokolu VV dle ČSN 33 2000-5-52 ed.2</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom font import (Inter) - Main UI font */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Light blue-grey background */
        }
        /* Hide scrollbar for Chrome, Safari and Opera */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        /* Hide scrollbar for IE, Edge and Firefox */
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        /* Styling for multiple select options */
        select[multiple] {
            min-height: 8rem; /* Enough height to show multiple options without too much scroll */
            width: 100%;
        }
        /* Specific font for protocol output */
        #protocolOutputContainer {
            font-family: Arial, sans-serif;
        }
        /* Basic table styling for printability */
        #protocolOutputContainer table {
            border-collapse: collapse;
            width: 100%;
            margin-bottom: 1rem;
        }
        #protocolOutputContainer th,
        #protocolOutputContainer td {
            border: 1px solid #ccc;
            padding: 0.75rem;
            text-align: left;
            vertical-align: top;
            word-wrap: break-word; /* Ensure long text breaks */
        }
        #protocolOutputContainer th {
            background-color: #e2e8f0; /* Light grey for headers */
            font-weight: bold;
        }
        /* Print specific styles */
        @media print {
            body {
                background-color: #fff;
                margin: 0;
                padding: 0;
            }
            /* Hide the entire input UI section when printing */
            #inputUI {
                display: none !important;
            }
            /* Ensure the protocol output is visible when printing */
            #protocolOutputContainer {
                display: block !important;
                max-height: none;
                overflow: visible;
                font-size: 10pt; /* Smaller font for print */
                padding: 0.5cm; /* Ensure padding for printed content */
                box-shadow: none !important; /* Remove shadows for print */
                border: none !important; /* Remove borders for print */
            }
            /* Hide elements within the protocol output that should not be printed (e.g., buttons) */
            #protocolOutputContainer .no-print-element {
                display: none !important;
            }
            .bg-white, .shadow-2xl, .border-gray-200 {
                box-shadow: none !important;
                border: none !important;
                padding: 0 !important;
            }
            #protocolOutputContainer table,
            #protocolOutputContainer th,
            #protocolOutputContainer td {
                border-color: #000; /* Darker borders for print */
            }
            /* Adjust margins and padding for better print layout */
            .p-4, .sm:p-6, .md:p-8 {
                padding: 0.5cm !important;
            }
        }
    </style>
</head>
<body class="p-4 sm:p-6 md:p-8 flex items-center justify-center min-h-screen">
    <div class="bg-white p-6 sm:p-8 md:p-10 rounded-xl shadow-2xl w-full max-w-4xl border border-gray-200">
        <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-900 mb-6 text-center">Generátor protokolu VV dle ČSN 33 2000-5-52 ed.2</h1>

        <div id="inputUI"> <!-- This section contains all form elements and will be hidden/shown dynamically -->
            <p class="text-gray-600 text-base mb-6 text-center">
                Tato aplikace vám pomůže generovat protokol místností včetně detailních vnějších vlivů dle normy ČSN 33 2000-5-52.
                Pro výběr více možností v rozbalovacích seznamech podržte klávesu <span class="font-bold text-gray-800">Ctrl</span> (nebo <span class="font-bold text-gray-800">Cmd</span> na Macu) a klikněte na ně.
            </p>

            <!-- Úvodní informace o protokolu -->
            <div class="space-y-4 mb-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label for="dateInput" class="block text-gray-700 text-lg font-semibold mb-2">Datum vypracování:</label>
                        <input type="date" id="dateInput" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-lg shadow-sm">
                    </div>
                    <div>
                        <label for="preparedByInput" class="block text-gray-700 text-lg font-semibold mb-2">Vypracoval (jméno/firma):</label>
                        <input type="text" id="preparedByInput" placeholder="Např. Ing. Jan Novák, ElektroServis s.r.o."
                               class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-lg shadow-sm">
                    </div>
                </div>
                <div>
                    <label for="clientInput" class="block text-gray-700 text-lg font-semibold mb-2">Zadavatel:</label>
                    <input type="text" id="clientInput" placeholder="Např. Karel Novák, Obec Náměstí"
                           class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-lg shadow-sm">
                </div>
                <div>
                    <label for="buildingHeader" class="block text-gray-700 text-lg font-semibold mb-2">Objekt:</label>
                    <input type="text" id="buildingHeader" placeholder="Např. Rodinný dům Novák, ulice Příčná 123, Praha"
                           class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-lg shadow-sm">
                </div>
                <div>
                    <label for="wiringSystemSelect" class="block text-gray-700 text-lg font-semibold mb-2">
                        Popis použitých typů vedení a způsobů uložení (dle čl. 521 a příl. A.52.3) - vícenásobný výběr (Ctrl/Cmd + klik):
                    </label>
                    <select id="wiringSystemSelect" multiple size="8"
                              class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-lg shadow-sm resize-y"></select>
                    <p class="text-xs text-gray-500 mt-1">
                        Vyberte relevantní typy vedení a referenční způsoby uložení z normy.
                    </p>
                </div>
                <div>
                    <label for="additionalNotes" class="block text-gray-700 text-lg font-semibold mb-2">
                        Doplňující poznámky a shoda s dalšími požadavky normy (např. úbytek napětí, ochrana před nadproudy, požární bezpečnost):
                    </label>
                    <textarea id="additionalNotes" rows="4" placeholder="Např. Úbytek napětí nepřesahuje normou dovolené hodnoty dle čl. 525. Ochrana před nadproudy řešena dle ČSN 33 2000-4-43. Zajištěna požární bezpečnost dle čl. 527."
                              class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-lg shadow-sm resize-y"></textarea>
                    <p class="text-xs text-gray-500 mt-1">
                        Zde můžete uvést obecná prohlášení o shodě s dalšími relevantními částmi normy ČSN 33 2000 (např. 4-41, 4-42, 5-54 atd.).
                    </p>
                </div>
            </div>

            <!-- Uložení/načtení protokolu -->
            <div class="mb-6 p-4 bg-purple-50 rounded-lg border border-purple-200">
                <p class="block text-gray-700 text-lg font-semibold mb-2">Název protokolu (pro uložení/načtení - generováno automaticky):</p>
                <input type="text" id="protocolNameInput" readonly disabled
                       class="w-full p-3 border border-gray-300 rounded-lg bg-gray-100 cursor-not-allowed focus:outline-none focus:ring-2 focus:ring-purple-500 text-lg shadow-sm mb-4">
                <div class="flex flex-col sm:flex-row justify-center gap-4">
                    <button id="saveProtocolBtn"
                            class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transform transition duration-300 ease-in-out hover:scale-105 text-lg w-full sm:w-auto">
                        Uložit protokol
                    </button>
                    <button id="loadProtocolBtn"
                            class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transform transition duration-300 ease-in-out hover:scale-105 text-lg w-full sm:w-auto">
                        Načíst protokol
                    </button>
                </div>
                <p id="storageMessage" class="text-center mt-2 text-sm font-medium hidden"></p>
            </div>


            <!-- Počet místností -->
            <div class="mb-6">
                <label for="numRooms" class="block text-gray-700 text-lg font-semibold mb-2">
                    Zadejte počet místností v budově:
                </label>
                <input type="number" id="numRooms" min="1" value="1"
                       class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-lg shadow-sm">
            </div>

            <!-- Kontejner pro dynamické místnosti -->
            <div id="roomsContainer" class="mb-8 space-y-6 no-scrollbar max-h-[70vh] overflow-y-auto pr-2">
                <!-- Místnosti se budou generovat zde -->
            </div>

            <!-- Tlačítka akcí -->
            <div class="flex flex-col sm:flex-row justify-center gap-4">
                <button id="generateProtocol"
                        class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transform transition duration-300 ease-in-out hover:scale-105 text-lg w-full sm:w-auto">
                    Generovat protokol
                </button>
                <button id="resetApp"
                        class="bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg transform transition duration-300 ease-in-out hover:scale-105 text-lg w-full sm:w-auto">
                    Resetovat
                </button>
            </div>
        </div> <!-- End of inputUI -->

        <!-- Výsledek protokolu (hidden by default) -->
        <div id="protocolOutputContainer" class="mt-8 hidden">
            <!-- Protocol content will be generated here as a table -->
            <div class="flex flex-col sm:flex-row justify-center gap-4 mt-4 no-print-element">
                <button id="printProtocol"
                        class="bg-gray-700 hover:bg-gray-800 text-white font-bold py-2 px-5 rounded-lg shadow-md transform transition duration-300 ease-in-out hover:scale-105 text-base w-full sm:w-auto">
                    Tisk protokolu (do PDF)
                </button>
                <button id="copyToClipboard"
                        class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-5 rounded-lg shadow-md transform transition duration-300 ease-in-out hover:scale-105 text-base w-full sm:w-auto">
                    Kopírovat do schránky (pro Word)
                </button>
            </div>
        </div>

        <!-- Zpráva o kopírování -->
        <div id="copyMessage" class="mt-4 text-center text-green-700 font-semibold hidden no-print-element">
            Text byl zkopírován do schránky!
        </div>
    </div>

    <script type="module">
        // Firebase imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase setup variables (provided by Canvas environment)
        // These are global variables provided by the Canvas environment.
        // We ensure they are defined, otherwise provide a fallback for local testing without Canvas.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfigRaw = typeof __firebase_config !== 'undefined' ? __firebase_config : '{}';
        let firebaseConfig = {};
        try {
            firebaseConfig = JSON.parse(firebaseConfigRaw);
        } catch (e) {
            console.error("Failed to parse Firebase config:", e);
        }
        
        let app;
        let db = null;
        let auth = null;
        let userId = null; // Will be set after authentication

        // DOM Elements
        const dateInput = document.getElementById('dateInput');
        const preparedByInput = document.getElementById('preparedByInput');
        const clientInput = document.getElementById('clientInput');
        const buildingHeaderInput = document.getElementById('buildingHeader');
        const wiringSystemSelect = document.getElementById('wiringSystemSelect');
        const additionalNotesInput = document.getElementById('additionalNotes');
        const protocolNameInput = document.getElementById('protocolNameInput');
        const saveProtocolBtn = document.getElementById('saveProtocolBtn');
        const loadProtocolBtn = document.getElementById('loadProtocolBtn');
        const storageMessage = document.getElementById('storageMessage');
        const numRoomsInput = document.getElementById('numRooms');
        const roomsContainer = document.getElementById('roomsContainer');
        const generateProtocolBtn = document.getElementById('generateProtocol');
        const resetAppBtn = document.getElementById('resetApp');
        const protocolOutputContainer = document.getElementById('protocolOutputContainer');
        const inputUI = document.getElementById('inputUI'); // Reference to the main input section wrapper
        let protocolOutputHtmlContent = '';
        let protocolOutputPlainContent = '';
        const copyToClipboardBtn = document.getElementById('copyToClipboard');
        const printProtocolBtn = document.getElementById('printProtocol');
        const copyMessage = document.getElementById('copyMessage');

        // Firebase Initialization and Authentication
        function initializeFirebase() {
            if (Object.keys(firebaseConfig).length > 0 && firebaseConfig.apiKey) {
                try {
                    app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);

                    onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            userId = user.uid;
                            console.log("Authenticated with user ID:", userId);
                        } else {
                            console.log("No user signed in, signing in anonymously...");
                            try {
                                const anonymousUser = await signInAnonymously(auth);
                                userId = anonymousUser.user.uid;
                                console.log("Signed in anonymously with user ID:", userId);
                            } catch (error) {
                                console.error("Anonymous sign-in failed:", error);
                                storageMessage.textContent = "Chyba přihlášení, ukládání/načítání nebude fungovat.";
                                storageMessage.style.color = 'red';
                            }
                        }
                    });
                } catch (e) {
                    console.error("Firebase initialization failed:", e);
                    storageMessage.textContent = "Chyba inicializace Firebase. Funkce ukládání/načítání nemusí fungovat.";
                    storageMessage.style.color = 'red';
                    saveProtocolBtn.disabled = true;
                    loadProtocolBtn.disabled = true;
                }
            } else {
                console.warn("Firebase configuration is missing or invalid. Save/Load features will not be available.");
                storageMessage.textContent = "Funkce ukládání/načítání (databáze) nejsou dostupné při spuštění souboru lokálně kvůli bezpečnostním omezením prohlížeče. Fungovat budou pouze online.";
                storageMessage.style.color = 'orange';
                storageMessage.classList.remove('hidden');
                saveProtocolBtn.disabled = true;
                loadProtocolBtn.disabled = true;
            }
        }

        // Predefined data
        const roomTypes = [
            "Obývací pokoj", "Kuchyně", "Ložnice", "Koupelna", "Chodba",
            "Komora", "Pracovna", "Dětský pokoj", "WC", "Technická místnost",
            "Sklad", "Předsíň", "Garáž", "Terasa", "Balkón", "Půda", "Sklep",
            "Jiná"
        ];

        const influenceCategories = [
            {
                label: "Atmosférické a mechanické vlivy:",
                idPrefix: "atmMech",
                hint: "Vlivy související s teplotou, vlhkostí, vodou, pevnými tělesy, rázy, vibracemi a ostatním mechanickým namáháním.",
                influences: [
                    { value: "AA - Okolní teplota", text: "AA - Okolní teplota" },
                    { value: "AB - Vysoká vlhkost", text: "AB - Vysoká vlhkost" },
                    { value: "AD - Přítomnost vody", text: "AD - Přítomnost vody" },
                    { value: "AE - Přítomnost cizích pevných těles", text: "AE - Přítomnost cizích pevných těles" },
                    { value: "AG - Ráz", text: "AG - Ráz" },
                    { value: "AH - Vibrace", text: "AH - Vibrace" },
                    { value: "AJ - Ostatní mechanická namáhání", text: "AJ - Ostatní mechanická namáhání" }
                ]
            },
            {
                label: "Chemické, biologické a další vlivy prostředí:",
                idPrefix: "chemBioOther",
                hint: "Vlivy korozivních/znečišťujících látek, rostlinstva/plísní, živočichů, slunečního záření, seizmických účinků a větru.",
                influences: [
                    { value: "AF - Korozivní/znečišťující látky", text: "AF - Korozivní/znečišťující látky" },
                    { value: "AK - Výskyt rostlinstva nebo plísní", text: "AK - Výskyt rostlinstva nebo plísní" },
                    { value: "AL - Výskyt živočichů", text: "AL - Výskyt živočíchů" },
                    { value: "AN - Sluneční záření a ultrafialové záření", text: "AN - Sluneční záření a ultrafialové záření" },
                    { value: "AP - Seizmické účinky", text: "AP - Seizmické účinky" },
                    { value: "AR - Vítr", text: "AR - Vítr" }
                ]
            },
            {
                label: "Vlivy osob, nebezpečí a konstrukční vlivy:",
                idPrefix: "personHazardConst",
                hint: "Vlivy způsobilosti osob, styku se zemí, možnosti evakuace, hořlavosti materiálů, nebezpečí výbuchu a požáru, a konstrukce budovy.",
                influences: [
                    { value: "BA - Způsobilost osob", text: "BA - Způsobilost osob" },
                    { value: "BB - Styk s potenciálem země", text: "BB - Styk s potenciálem země" },
                    { value: "BC - Možnost evakuace", text: "BC - Možnost evakuace" },
                    { value: "CA - Hořlavost stavebních hmot", text: "CA - Hořlavost stavebních hmot" },
                    { value: "DB - Nebezpečí výbuchu", text: "DB - Nebezpečí výbuchu" },
                    { value: "DC - Nebezpečí požáru", text: "DC - Nebezpečí požáru" },
                    { value: "BE - Povaha zpracovávaných nebo skladovaných látek", text: "BE - Povaha zpracovávaných nebo skladovaných látek" },
                    { value: "CB - Konstrukce budovy", text: "CB - Konstrukce budovy" }
                ]
            }
        ];

        // Comprehensive details for explanations, including article references
        const influenceDetails = {
            "AA - Okolní teplota": {
                article: "522.1",
                explanation: "Vedení musí být zvolena a zřízena tak, aby odpovídala všem teplotám mezi nejvyšší a nejnižší teplotou okolí v místě instalace a aby nebyly překročeny mezní teploty při normálním provozu a v případě poruchy."
            },
            "AB - Vysoká vlhkost": {
                article: "522.3",
                explanation: "Vedení musí být zvolena a zřízena tak, aby nedošlo k žádnému poškození kondenzací vzdušné vlhkosti nebo vniknutím vody. Hotová vedení musí vyhovovat stupni ochrany IP."
            },
            "AD - Přítomnost vody": {
                article: "522.3",
                explanation: "Vedení musí být zvolena a zřízena tak, aby nedošlo k žádnému poškození kondenzací vzdušné vlhkosti nebo vniknutím vody (např. stříkající voda, ponoření). Hotová vedení musí vyhovovat stupni ochrany IP."
            },
            "AE - Přítomnost cizích pevných těles": {
                article: "522.4",
                explanation: "Vedení musí být zvolena a zřízena tak, aby se minimalizovalo nebezpečí od vniknutí cizích pevných těles (např. prach, úlomky). Hotová vedení musí odpovídat stupni ochrany krytem IP."
            },
            "AF - Korozivní/znečišťující látky": {
                article: "522.5",
                explanation: "Pokud je pravděpodobná přítomnost korozivních nebo znečišťujících látek, musí být části vedení vhodně chráněny nebo vyrobeny z odolného materiálu (např. chemické výpary, solanka)."
            },
            "AG - Ráz": {
                article: "522.6",
                explanation: "Vedení musí být zvolena a zřízena tak, aby se minimalizovalo nebezpečí od mechanického namáhání, např. rázem, úderem nebo stlačením (např. prostory s vysokozdvižnými vozíky)."
            },
            "AH - Vibrace": {
                article: "522.7",
                explanation: "Vedení podepíraná nebo připevněná k vibrujícím zařízením musí být pro tyto podmínky vhodná, zvláště kabely a kabelové spoje (např. připojení k motorům)."
            },
            "AJ - Ostatní mechanická namáhání": {
                article: "522.8",
                explanation: "Vedení musí být zvolena a zřízena tak, aby se zabránilo poškození kabelů a jejich zakončení během instalace, používání nebo údržby (např. tahové namáhání, ohyby, upevnění, uložení v zemi)."
            },
            "AK - Výskyt rostlinstva nebo plísní": {
                article: "522.9",
                explanation: "V místech s prokázaným nebo předpokládaným rizikem růstu rostlinstva nebo plísní musí být vedení vhodně zvolena nebo přijata zvláštní ochranná opatření (např. uzavřené systémy)."
            },
            "AL - Výskyt živočichů": {
                article: "522.10",
                explanation: "V místech s prokázaným nebo předpokládaným rizikem působení živočichů (např. hlodavců) musí být vedení vhodně zvolena nebo přijata zvláštní ochranná opatření (např. mechanická ochrana)."
            },
            "AN - Sluneční záření a ultrafialové záření": {
                article: "522.11",
                explanation: "Vystavená vedení musí být pro tyto podmínky vhodného provedení nebo vybavena odpovídajícím stíněním proti slunečnímu a ultrafialovému záření."
            },
            "AP - Seizmické účinky": {
                article: "522.12",
                explanation: "Vedení musí být zvolena a instalována s řádným ohledem na seizmická nebezpečí v místě instalace, s důrazem na upevnění a poddajnost spojení."
            },
            "AR - Vítr": {
                article: "522.13",
                explanation: "Vlivy větru je třeba posuzovat ve spojení s vibracemi (AH) a ostatním mechanickým namáháním (AJ), které mohou způsobit poškození vedení."
            },
            "BE - Povaha zpracovávaných nebo skladovaných látek": {
                article: "522.14",
                explanation: "Je třeba brát ohled na povahu látek, které mohou ovlivnit požární bezpečnost instalace. Viz také článek 422 (ochrana před požárem) a 527 (omezení šíření požáru)."
            },
            "CB - Konstrukce budovy": {
                article: "522.15",
                explanation: "Vedení musí být zvolena a instalována s ohledem na možný posun konstrukce (např. dilatace) tak, aby vodiče a kabely nebyly vystaveny nadměrnému mechanickému namáhání."
            },
            "BA - Způsobilost osob": {
                article: "ČSN 33 2000-4-41 (Obecně)",
                explanation: "Nutnost zohlednit úroveň způsobilosti osob (např. znalé, poučené, laici) při návrhu a umístění elektrických instalací pro zajištění ochrany před úrazem elektrickým proudem."
            },
            "BB - Styk s potenciálem země": {
                article: "ČSN 33 2000-4-41 (Obecně)",
                explanation: "Vliv možnosti styku osob s potenciálem země, který ovlivňuje požadavky na doplňková ochranná opatření (např. v mokrých prostorech)."
            },
            "BC - Možnost evakuace": {
                article: "ČSN 33 2000-4-41 / 527 (Obecně)",
                explanation: "Zohlednění podmínek evakuace osob v případě nebezpečí, což ovlivňuje volbu a instalaci vedení, zejména v únikových cestách a shromaždištích."
            },
            "CA - Hořlavost stavebních hmot": {
                article: "527 (Obecně)",
                explanation: "Výběr a stavba vedení musí minimalizovat šíření požáru s ohledem na hořlavost stavebních hmot v objektu (např. dřevostavby)."
            },
            "DB - Nebezpečí výbuchu": {
                article: "422 / 527 (Obecně)",
                explanation: "Instalace musí být provedena tak, aby byly splněny zvláštní požadavky na ochranu v prostorách s nebezpečím výbuchu (např. zóny s výbušnou atmosférou)."
            },
            "DC - Nebezpečí požáru": {
                article: "422 / 527 (Obecně)",
                explanation: "Instalace musí být navržena a zřízena s ohledem na ochranu před vznikem a šířením požáru, včetně volby vhodných materiálů a uspořádání vedení (např. místnosti s otevřeným ohněm, sklady hořlavých látek)."
            }
        };


        const wiringSystemOptions = [
            { optgroup: "Obecné typy vedení (čl. 521)" },
            { value: "521.4: Přípojnicové rozvody a soustavy připojnic", text: "521.4: Přípojnicové rozvody a soustavy připojnic" },
            { value: "521.5: Obvody střídavého proudu - elektromagnetické účinky", text: "521.5: Obvody střídavého proudu - elektromagnetické účinky" },
            { value: "521.6: Systémy instalačních trubek, kanálů, lávek a roštů", text: "521.6: Systémy instalačních trubek, kanálů, lávek a roštů" },
            { value: "521.7: Několik obvodů v jednom kabelu", text: "521.7: Několik obvodů v jednom kabelu" },
            { value: "521.8: Uspořádání obvodů", text: "521.8: Uspořádání obvodů" },
            { value: "521.9: Použití ohebných kabelů a šňůr", text: "521.9: Použití ohebných kabelů a šňůr" },
            { value: "521.10: Instalace kabelů (izolované vodiče)", text: "521.10: Instalace kabelů (izolované vodiče)" },
            { optgroup: "Referenční způsoby uložení (Příloha A.52.3)" },
            { value: "A1: Izol. vodiče/jednožilov. kabely v trubce v tepelně izolační stěně", text: "A1: Izol. vodiče/jednožilov. kabely v trubce v tepelně izolační stěně" },
            { value: "A2: Vícežilové kabely v trubce v tepelně izolační stěně", text: "A2: Vícežilové kabely v trubce v tepelně izolační stěně" },
            { value: "B1: Izol. vodiče/jednožilov. kabely v trubce na dřevěné/zděné stěně", text: "B1: Izol. vodiče/jednožilov. kabely v trubce na dřevěné/zděné stěně" },
            { value: "B2: Vícežilové kabely v trubce na dřevěné/zděné stěně", text: "B2: Vícežilové kabely v trubce na dřevěné/zděné stěně" },
            { value: "C: Jednožilov./vícežilov. kabely na dřevěné/zděné stěně (přímo)", text: "C: Jednožilov./vícežilov. kabely na dřevěné/zděné stěně (přímo)" },
            { value: "D1: Vícežilov. kabely v trubkách v zemi", text: "D1: Vícežilov. kabely v trubkách v zemi" },
            { value: "D2: Jednožilov./vícežilov. kabely přímo v zemi", text: "D2: Jednožilov./vícežilov. kabely přímo v zemi" },
            { value: "E: Vícežilov. kabely ve volném vzduchu (od zdi >0.3 průměru)", text: "E: Vícežilov. kabely ve volném vzduchu (od zdi >0.3 průměru)" },
            { value: "F: Jednožilov. kabely ve volném vzduchu (dotýkající se)", text: "F: Jednožilov. kabely ve volném vzduchu (dotýkající se)" },
            { value: "G: Jednožilov. kabely ve volném vzduchu (vzdálené)", text: "G: Jednožilov. kabely ve volném vzduchu (vzdálené)" },
            { optgroup: "Další způsoby uložení (Příloha A.52.3 - Příklady)" },
            { value: "Položka 10,11: V zavěšených úložných kanálech", text: "Položka 10,11: V zavěšených úložných kanálech" },
            { value: "Položka 12: V tvárnicích", text: "Položka 12: V tvárnicích" },
            { value: "Položka 15,16: V rámech dveří/oken", text: "Položka 15,16: V rámech dveří/oken" },
            { value: "Položka 20-23: Na dřevěné/zděné stěně, pod stropem", text: "Položka 20-23: Na dřevěné/zděné stěně, pod stropem" },
            { value: "Položka 30-36: Na lávkách, žebřících, konzolách, izolátorech", text: "Položka 30-36: Na lávkách, žebřících, konzolách, izolátorech" },
            { value: "Položka 40-47: Ve stavebních dutinách (trubky, kanály)", text: "Položka 40-47: Ve stavebních dutinách (trubky, kanály)" },
            { value: "Položka 50-53: V podlaze (zapuštěné kanály)", text: "Položka 50-53: V podlaze (zapuštěné kanály)" },
            { value: "Položka 54-56: V kabelových kanálech (větrané/nevětrané)", text: "Položka 54-56: V kabelových kanálech (větrané/nevětrané)" },
            { value: "Položka 57-60: Přímo ve zdivu", text: "Položka 57-60: Přímo ve zdivu" },
            { value: "Položka 70-73: Uložené v zemi", text: "Položka 70-73: Uložené v zemi" }
        ];


        /**
         * Populates the wiringSystemSelect dropdown.
         */
        function populateWiringSystemSelect() {
            wiringSystemSelect.innerHTML = ''; // Clear existing options
            let currentOptgroup = null;

            wiringSystemOptions.forEach(option => {
                if (option.optgroup) {
                    currentOptgroup = document.createElement('optgroup');
                    currentOptgroup.label = option.optgroup;
                    wiringSystemSelect.appendChild(currentOptgroup);
                } else {
                    const opt = document.createElement('option');
                    opt.value = option.value;
                    opt.textContent = option.text;
                    if (currentOptgroup) {
                        currentOptgroup.appendChild(opt);
                    } else {
                        wiringSystemSelect.appendChild(opt);
                    }
                }
            });
        }

        /**
         * Generates the room input fields based on the number specified in the input.
         * This version creates elements more explicitly for better compatibility.
         */
        function generateRoomInputs() {
            const num = parseInt(numRoomsInput.value);
            roomsContainer.innerHTML = ''; // Clear existing rooms

            if (isNaN(num) || num < 1) {
                return;
            }

            for (let i = 0; i < num; i++) {
                const roomDiv = document.createElement('div');
                roomDiv.className = 'p-4 bg-gray-100 rounded-xl border border-gray-200 shadow-md';

                // Room Title
                const h3 = document.createElement('h3');
                h3.className = 'text-xl font-semibold text-gray-800 mb-4';
                h3.textContent = `Místnost ${i + 1}`;
                roomDiv.appendChild(h3);

                const gridDiv = document.createElement('div');
                gridDiv.className = 'grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-3';

                // Room Description
                let divDesc = document.createElement('div');
                divDesc.className = 'flex-grow col-span-1 sm:col-span-2';
                divDesc.innerHTML = `
                    <label for="roomDescription${i}" class="block text-gray-700 text-sm font-medium mb-1">Popis místnosti:</label>
                    <input type="text" id="roomDescription${i}" placeholder="Např. Obývací pokoj s krbem, Kuchyně, Technická místnost"
                           class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-400 text-base room-description">
                    <p class="text-xs text-gray-500 mt-1">Zadejte typ a volitelný název místnosti.</p>
                `;
                gridDiv.appendChild(divDesc);

                // No Influences Checkbox
                let divCheckbox = document.createElement('div');
                divCheckbox.className = 'flex-grow col-span-1 sm:col-span-2 flex items-center mb-2';
                divCheckbox.innerHTML = `
                    <input type="checkbox" id="noInfluencesCheckbox${i}" class="mr-2 h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded no-influences-checkbox">
                    <label for="noInfluencesCheckbox${i}" class="text-gray-700 font-medium">Explicitně označit, že nebyly zadány žádné specifické vnější vlivy.</label>
                `;
                gridDiv.appendChild(divCheckbox);

                // Influences Selects (Dynamically created)
                influenceCategories.forEach(category => {
                    let divCategory = document.createElement('div');
                    divCategory.className = 'flex-grow col-span-1 sm:col-span-2';

                    let label = document.createElement('label');
                    label.htmlFor = `${category.idPrefix}${i}`;
                    label.className = 'block text-gray-700 text-sm font-medium mb-1';
                    label.textContent = category.label;
                    divCategory.appendChild(label);

                    let select = document.createElement('select');
                    select.id = `${category.idPrefix}${i}`;
                    select.multiple = true;
                    select.size = 5;
                    select.className = 'w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-400 text-base influence-select max-h-32 overflow-y-auto';

                    category.influences.forEach(influence => {
                        let option = document.createElement('option');
                        option.value = influence.value;
                        option.textContent = influence.text;
                        select.appendChild(option);
                    });
                    divCategory.appendChild(select);

                    let hint = document.createElement('p');
                    hint.className = 'text-xs text-gray-500 mt-1';
                    hint.textContent = category.hint;
                    divCategory.appendChild(hint);

                    gridDiv.appendChild(divCategory);
                });

                roomDiv.appendChild(gridDiv);
                roomsContainer.appendChild(roomDiv);

                // Attach event listener for the checkbox after it's in the DOM
                const checkbox = roomDiv.querySelector(`#noInfluencesCheckbox${i}`);
                const influenceSelects = roomDiv.querySelectorAll(`.influence-select`);
                checkbox.addEventListener('change', () => {
                    influenceSelects.forEach(select => {
                        select.disabled = checkbox.checked;
                        if (checkbox.checked) {
                            Array.from(select.options).forEach(option => option.selected = false);
                        }
                    });
                });
            }
        }

        // Helper to collect all form data into an object
        function collectFormData() {
            const roomsData = [];
            const numRooms = parseInt(numRoomsInput.value);

            for (let i = 0; i < numRooms; i++) {
                const roomDescriptionEl = document.getElementById(`roomDescription${i}`);
                const noInfluencesCheckbox = document.getElementById(`noInfluencesCheckbox${i}`);
                
                const roomDescription = roomDescriptionEl ? roomDescriptionEl.value.trim() : "";
                const noInfluencesChecked = noInfluencesCheckbox ? noInfluencesCheckbox.checked : false;

                let selectedInfluences = [];
                if (!noInfluencesChecked) { // Only collect influences if checkbox is NOT checked
                    influenceCategories.forEach(category => {
                        const influenceSelectEl = document.getElementById(`${category.idPrefix}${i}`);
                        if (influenceSelectEl) {
                            const selected = Array.from(influenceSelectEl.options)
                                .filter(option => option.selected)
                                .map(option => option.value);
                            selectedInfluences = selectedInfluences.concat(selected);
                        }
                    });
                }
                
                roomsData.push({
                    description: roomDescription,
                    noInfluencesChecked: noInfluencesChecked,
                    selectedInfluences: selectedInfluences // Empty array if checkbox checked
                });
            }

            const selectedWiringSystems = Array.from(wiringSystemSelect.selectedOptions).map(option => option.value);

            return {
                date: dateInput.value,
                preparedBy: preparedByInput.value.trim(),
                client: clientInput.value.trim(),
                buildingHeader: buildingHeaderInput.value.trim(),
                selectedWiringSystems: selectedWiringSystems,
                additionalNotes: additionalNotesInput.value.trim(),
                numRooms: numRooms,
                rooms: roomsData
            };
        }

        // Helper to populate the form with loaded data
        function populateFormWithData(data) {
            dateInput.value = data.date || '';
            preparedByInput.value = data.preparedBy || '';
            clientInput.value = data.client || '';
            buildingHeaderInput.value = data.buildingHeader || '';
            additionalNotesInput.value = data.additionalNotes || '';

            // Update generated protocol name after loading header data
            updateProtocolNameInput();

            // Reset wiringSystemSelect first
            Array.from(wiringSystemSelect.options).forEach(option => option.selected = false);
            if (data.selectedWiringSystems) {
                data.selectedWiringSystems.forEach(selectedVal => {
                    const option = Array.from(wiringSystemSelect.options).find(opt => opt.value === selectedVal);
                    if (option) {
                        option.selected = true;
                    }
                });
            }

            // Populate rooms dynamically (this calls generateRoomInputs)
            numRoomsInput.value = data.numRooms || 1;
            generateRoomInputs(); 

            // Now fill in the details for each room using a small delay for DOM rendering
            setTimeout(() => {
                data.rooms.forEach((roomData, i) => {
                    const roomDescriptionEl = document.getElementById(`roomDescription${i}`);
                    const noInfluencesCheckbox = document.getElementById(`noInfluencesCheckbox${i}`);

                    if (roomDescriptionEl) {
                        roomDescriptionEl.value = roomData.description || '';
                    }

                    if (noInfluencesCheckbox) {
                        noInfluencesCheckbox.checked = roomData.noInfluencesChecked || false;
                        // Trigger change event to disable/enable dropdowns
                        const event = new Event('change');
                        noInfluencesCheckbox.dispatchEvent(event);
                    }

                    if (roomData.selectedInfluences && !roomData.noInfluencesChecked) {
                        influenceCategories.forEach(category => {
                            const influenceSelectEl = document.getElementById(`${category.idPrefix}${i}`);
                            if (influenceSelectEl) {
                                Array.from(influenceSelectEl.options).forEach(option => {
                                    option.selected = roomData.selectedInfluences.includes(option.value);
                                });
                            }
                        });
                    }
                });
                storageMessage.textContent = "Protokol načten úspěšně!";
                storageMessage.style.color = 'green';
            }, 50); // Small delay
        }


        /**
         * Saves the current protocol data to Firestore.
         */
        async function saveProtocol() {
            if (!db || !userId) {
                storageMessage.textContent = "Chyba: Databáze není inicializována nebo uživatel není přihlášen.";
                storageMessage.style.color = 'red';
                return;
            }
            const protocolName = protocolNameInput.value.trim();
            if (!protocolName) {
                storageMessage.textContent = "Název protokolu je prázdný. Vyplňte prosím datum a/nebo název objektu.";
                storageMessage.style.color = 'red';
                return;
            }

            const protocolData = collectFormData();
            try {
                // Path: /artifacts/{appId}/users/{userId}/protocols/{protocolName}
                const protocolDocRef = doc(db, `artifacts/${appId}/users/${userId}/protocols`, protocolName);
                await setDoc(protocolDocRef, protocolData);
                storageMessage.textContent = `Protokol "${protocolName}" uložen úspěšně!`;
                storageMessage.style.color = 'green';
            } catch (e) {
                console.error("Error saving document: ", e);
                storageMessage.textContent = `Chyba při ukládání protokolu "${protocolName}": ${e.message}`;
                storageMessage.style.color = 'red';
            }
        }

        /**
         * Loads a protocol from Firestore.
         */
        async function loadProtocol() {
            if (!db || !userId) {
                storageMessage.textContent = "Chyba: Databáze není inicializována nebo uživatel není přihlášen.";
                storageMessage.style.color = 'red';
                return;
            }
            const protocolName = protocolNameInput.value.trim();
            if (!protocolName) {
                storageMessage.textContent = "Název protokolu je prázdný. Vyplňte prosím datum a/nebo název objektu pro načtení.";
                storageMessage.style.color = 'red';
                return;
            }

            try {
                const protocolDocRef = doc(db, `artifacts/${appId}/users/${userId}/protocols`, protocolName);
                const docSnap = await getDoc(protocolDocRef);

                if (docSnap.exists()) {
                    const loadedData = docSnap.data();
                    populateFormWithData(loadedData);
                } else {
                    storageMessage.textContent = `Protokol "${protocolName}" nebyl nalezen.`;
                    storageMessage.style.color = 'orange';
                    console.log("No such document!");
                }
            } catch (e) {
                console.error("Error loading document: ", e);
                storageMessage.textContent = `Chyba při načítání protokolu "${protocolName}": ${e.message}`;
                storageMessage.style.color = 'red';
            }
        }

        /**
         * Updates the automatically generated protocol name for saving/loading.
         */
        function updateProtocolNameInput() {
            const dateVal = dateInput.value;
            const buildingNameVal = buildingHeaderInput.value.trim();

            let formattedDate = '';
            if (dateVal) {
                formattedDate = dateVal.replace(/-/g, ''); // Remove dashes from date (YYYYMMDD)
            }

            // Sanitize building name: replace non-alphanumeric with underscore, remove leading/trailing underscores
            const sanitizedBuildingName = buildingNameVal
                .replace(/[^a-zA-Z0-9ěščřžýáíéóúůĚŠČŘŽÝÁÍÉÓÚŮ]+/g, '_') // Replace non-alphanumeric with underscore
                .replace(/^_+|_+$/g, ''); // Remove leading/trailing underscores

            let generatedName = '';
            if (formattedDate && sanitizedBuildingName) {
                generatedName = `${formattedDate}_${sanitizedBuildingName}`;
            } else if (formattedDate) {
                generatedName = formattedDate;
            } else if (sanitizedBuildingName) {
                generatedName = sanitizedBuildingName;
            } else {
                generatedName = ''; // Or some default like 'Novy_protokol'
            }
            protocolNameInput.value = generatedName;
            
            // Show message about auto-generation if name is generated
            if (generatedName) {
                 storageMessage.textContent = "Název protokolu je generován automaticky z data a názvu objektu.";
                 storageMessage.style.color = 'gray';
                 storageMessage.classList.remove('hidden');
            } else {
                storageMessage.classList.add('hidden');
            }
        }


        /**
         * Generates the protocol HTML and plain text output.
         */
        function generateProtocol() {
            const data = collectFormData(); // Use the new collectFormData function

            let protocolHtml = "";
            let plainTextForCopy = "";
            const roomsExplicitlyMarkedNoInfluences = [];
            const allSelectedUniqueInfluences = new Set(); // To store unique influences for explanation section
            const generatedProtocolNumber = protocolNameInput.value; // Get the generated protocol name/number

            // --- Main Protocol Title (first in HTML and Plain Text) ---
            protocolHtml += `
                <h2 class="text-xl font-bold text-gray-800 my-4 text-center">
                    PROTOKOL O URČENÍ VNĚJŠÍCH VLIVŮ<br>
                    dle ČSN 33 2000-5-52 ed.2
                </h2>
            `;
            plainTextForCopy += "PROTOKOL O URČENÍ VNĚJŠÍCH VLIVŮ\n";
            plainTextForCopy += "dle ČSN 33 2000-5-52 ed.2\n\n";

            // --- Build Header Details Section (HTML and Plain Text) ---
            // Combine Datum vypracování and Číslo protokolu on one line
            protocolHtml += `<div style="display: flex; justify-content: space-between; align-items: flex-start;">`;
            plainTextForCopy += ``;

            if (data.date) {
                protocolHtml += `<p><strong>Datum vypracování:</strong> ${data.date}</p>`;
                plainTextForCopy += `Datum vypracování: ${data.date}`;
            }
            if (generatedProtocolNumber) {
                protocolHtml += `<p><strong>Číslo protokolu:</strong> ${generatedProtocolNumber}</p>`;
                // Pad with spaces for plain text alignment (approximate)
                const dateLen = data.date ? `Datum vypracování: ${data.date}`.length : 0;
                const protocolNumString = `Číslo protokolu: ${generatedProtocolNumber}`;
                const totalLen = 80; // Approximate line length for plain text
                const padding = Math.max(1, totalLen - dateLen - protocolNumString.length);
                plainTextForCopy += ' '.repeat(padding) + protocolNumString + '\n';
            } else if (data.date) {
                plainTextForCopy += '\n'; // Add newline if only date exists
            }


            protocolHtml += `</div>`; // Close flex container for date/protocol number

            if (data.preparedBy) {
                protocolHtml += `<p><strong>Vypracoval:</strong> ${data.preparedBy}</p>`;
                plainTextForCopy += `Vypracoval: ${data.preparedBy}\n`;
            }
            if (data.client) {
                protocolHtml += `<p><strong>Zadavatel:</strong> ${data.client}</p>`;
                plainTextForCopy += `Zadavatel: ${data.client}\n`;
            }
            if (data.buildingHeader) {
                protocolHtml += `<p><strong>Objekt:</strong> ${data.buildingHeader}</p>`;
                plainTextForCopy += `Objekt: ${data.buildingHeader}\n`;
            }
            if (data.selectedWiringSystems && data.selectedWiringSystems.length > 0) {
                protocolHtml += `<p><strong>Popis použitých typů vedení a způsobů uložení (dle čl. 521 a příl. A.52.3):</strong><br>${data.selectedWiringSystems.join(', ').replace(/\n/g, '<br>')}</p>`;
                plainTextForCopy += `\nPopis použitých typů vedení a způsobů uložení (dle čl. 521 a příl. A.52.3):\n${data.selectedWiringSystems.join(', ')}\n`;
            }
            if (data.additionalNotes) {
                protocolHtml += `<p><strong>Doplňující poznámky a shoda s dalšími požadavky normy:</strong><br>${data.additionalNotes.replace(/\n/g, '<br>')}</p>`;
                plainTextForCopy += `\nDoplňující poznámky a shoda s dalšími požadavky normy:\n${data.additionalNotes}\n`;
            }

            protocolHtml += `<p class="mt-4">---</p>`; // Separator for HTML
            plainTextForCopy += "\n---\n\n"; // Separator for plain text

            if (isNaN(data.numRooms) || data.numRooms < 1) {
                protocolHtml += `<p>Žádné místnosti nebyly zadány. Zadejte prosím počet místností.</p>`;
                plainTextForCopy += "Žádné místnosti nebyly zadány. Zadejte prosím počet místností.\n";
            } else {
                // --- Start Table HTML ---
                protocolHtml += `
                    <table>
                        <thead>
                            <tr>
                                <th>Číslo</th>
                                <th>Popis místnosti</th>
                                <th>Vnější vlivy</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                data.rooms.forEach((roomData, i) => {
                    let influencesOutput = '';
                    if (roomData.selectedInfluences && roomData.selectedInfluences.length > 0) {
                        influencesOutput = roomData.selectedInfluences.join(', ');
                        roomData.selectedInfluences.forEach(inf => allSelectedUniqueInfluences.add(inf)); // Collect for explanation
                    } else {
                        influencesOutput = "Pro tuto místnost nebyly zadány žádné specifické vnější vlivy.";
                        if (roomData.noInfluencesChecked) {
                            roomsExplicitlyMarkedNoInfluences.push(roomData.description);
                        }
                    }

                    // --- Add Row to Table HTML ---
                    protocolHtml += `
                        <tr>
                            <td>${i + 1}.</td>
                            <td>${roomData.description || 'Nezadáno'}</td>
                            <td>${influencesOutput}</td>
                        </tr>
                    `;

                    // --- Add to Plain Text for Copy ---
                    plainTextForCopy += `${i + 1}. Popis místnosti: ${roomData.description || 'Nezadáno'}\n`;
                    plainTextForCopy += `   Vnější vlivy: ${influencesOutput}\n\n`;
                });

                // --- Close Table HTML ---
                protocolHtml += `</tbody></table>`;

                // Add summary for rooms with EXPLICITLY CHECKED "no specific influences"
                if (roomsExplicitlyMarkedNoInfluences.length > 0) {
                    protocolHtml += `<p class="mt-4">---</p><p><strong>Souhrn místností, pro které bylo explicitně uvedeno, že nebyly zadány žádné specifické vnější vlivy:</strong></p><ul>`;
                    plainTextForCopy += "\n---\n\nSouhrn místností, pro které bylo explicitně uvedeno, že nebyly zadány žádné specifické vnější vlivy:\n";

                    roomsExplicitlyMarkedNoInfluences.forEach((room) => {
                        protocolHtml += `<li>- ${room}</li>`;
                        plainTextForCopy += `- ${room}\n`;
                    });
                    protocolHtml += `</ul><p class="mt-2 text-sm text-gray-700 leading-relaxed">`;
                    plainTextForCopy += "\n";

                    // Add the explanatory text from the user
                    const normExplanation = `V souladu s normou. ČSN 33 2000-5-51 (která je základní pro určování vnějších vlivů, na níž ČSN 33 2000-5-52 navazuje) připouští několik způsobů, jak vnější vlivy v protokolu uvádět. Jedna z variant je uvést pouze vlivy, které nejsou považovány za normální nebo se v daném prostoru vyskytují, a ostatní (ty, které se nevyskytují nebo jsou "normální") shrnout. Když se u místnosti ukáže "Vnější vlivy: Nezadáno", v podstatě tím říká, že pro danou místnost nebyly vybrány žádné specifické (a tedy potenciálně abnormální) vnější vlivy z nabízených kategorií. To je implicitní vyjádření, že buď vlivy z těchto kategorií nejsou přítomny, nebo spadají pod "normální" podmínky, které není nutné explicitně jmenovat.`;
                    protocolHtml += normExplanation;
                    plainTextForCopy += normExplanation + "\n";
                    protocolHtml += `</p>`;
                }
            }

            // --- Signature Section ---
            protocolHtml += `
                <div class="mt-8 pt-4 border-t border-gray-300 text-center">
                    <p class="mb-4">_________________________</p>
                    <p>Podpis</p>
                </div>
            `;
            plainTextForCopy += "\n\n_________________________\n";
            plainTextForCopy += "Podpis\n";

            // --- Explanations of Selected Influences ---
            if (allSelectedUniqueInfluences.size > 0) {
                protocolHtml += `
                    <div class="mt-8 pt-4 border-t border-gray-300">
                        <h3 class="text-lg font-bold text-gray-800 mb-3 text-center">Vysvětlivky k vybraným vnějším vlivům dle ČSN 33 2000-5-52 ed.2:</h3>
                        <ul class="list-disc ml-6 text-sm">
                `;
                plainTextForCopy += "\n\n--- VYSVĚTLIVKY K VYBRANÝM VNĚJŠÍM VLIVŮM DLE ČSN 33 2000-5-52 ed.2 ---\n";

                allSelectedUniqueInfluences.forEach(influenceKey => {
                    const detail = influenceDetails[influenceKey];
                    if (detail) {
                        protocolHtml += `<li><strong>${influenceKey}</strong> (Článek ${detail.article}): ${detail.explanation}</li>`;
                        plainTextForCopy += `- ${influenceKey} (Článek ${detail.article}): ${detail.explanation}\n`;
                    }
                });
                protocolHtml += `</ul></div>`;
            }


            // Update the display container with generated HTML
            protocolOutputContainer.innerHTML = protocolHtml; // Set the generated content
            protocolOutputHtmlContent = protocolOutputContainer.innerHTML; // Store HTML for copying
            protocolOutputPlainContent = plainTextForCopy; // Store plain text for copying
            
            // Add Print and Copy buttons below the protocol (re-rendered each time)
            protocolOutputContainer.innerHTML += `
                <div class="flex flex-col sm:flex-row justify-center gap-4 mt-8 no-print-element">
                    <button id="printProtocol"
                            class="bg-gray-700 hover:bg-gray-800 text-white font-bold py-2 px-5 rounded-lg shadow-md transform transition duration-300 ease-in-out hover:scale-105 text-base w-full sm:w-auto">
                        Tisk protokolu (do PDF)
                    </button>
                    <button id="copyToClipboard"
                            class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-5 rounded-lg shadow-md transform transition duration-300 ease-in-out hover:scale-105 text-base w-full sm:w-auto">
                        Kopírovat do schránky (pro Word)
                    </button>
                </div>
            `;


            // Re-attach event listeners for newly rendered buttons
            document.getElementById('copyToClipboard').addEventListener('click', copyHtmlToClipboard);
            document.getElementById('printProtocol').addEventListener('click', () => window.print());

            // Show output and hide input
            inputUI.classList.add('hidden');
            protocolOutputContainer.classList.remove('hidden');
            copyMessage.classList.add('hidden'); // Hide copy message on new generation
        }

        /**
         * Resets the application to its initial state.
         */
        function resetApplication() {
            dateInput.value = '';
            preparedByInput.value = '';
            clientInput.value = '';
            buildingHeaderInput.value = '';
            protocolNameInput.value = ''; // Clear protocol name
            storageMessage.textContent = ''; // Clear storage message
            // Reset selected options for wiringSystemSelect
            Array.from(wiringSystemSelect.options).forEach(option => option.selected = false);
            additionalNotesInput.value = '';
            numRoomsInput.value = 1;
            roomsContainer.innerHTML = ''; // Clear rooms HTML
            generateRoomInputs(); // Re-generate default rooms structure
            protocolOutputContainer.innerHTML = '';
            protocolOutputHtmlContent = '';
            protocolOutputPlainContent = '';
            protocolOutputContainer.classList.add('hidden');
            copyMessage.classList.add('hidden');
            inputUI.classList.remove('hidden'); // Ensure input section is visible on reset
        }

        /**
         * Copies the generated HTML table and plain text to the clipboard.
         */
        async function copyHtmlToClipboard() {
            const htmlString = protocolOutputHtmlContent;
            const plainText = protocolOutputPlainContent;

            if (!htmlString || !plainText) {
                console.error("No content to copy.");
                return;
            }

            try {
                const htmlBlob = new Blob([htmlString], { type: 'text/html' });
                const textBlob = new Blob([plainText], { type: 'text/plain' });
                const clipboardItem = new ClipboardItem({
                    'text/html': htmlBlob,
                    'text/plain': textBlob
                });
                await navigator.clipboard.write([clipboardItem]);

                copyMessage.classList.remove('hidden');
                setTimeout(() => {
                    copyMessage.classList.add('hidden');
                }, 3000);

            } catch (err) {
                console.warn('Failed to copy HTML using Clipboard API, falling back to plain text:', err);
                fallbackCopyToClipboard(plainText);
            }
        }

        function fallbackCopyToClipboard(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.select();
            try {
                document.execCommand('copy');
                copyMessage.classList.remove('hidden');
                setTimeout(() => {
                    copyMessage.classList.add('hidden');
                }, 3000);
            } catch (err) {
                console.error('Failed to copy text using execCommand: ', err);
            } finally {
                document.body.removeChild(textarea);
            }
        }

        // Event Listeners
        numRoomsInput.addEventListener('input', generateRoomInputs);
        generateProtocolBtn.addEventListener('click', generateProtocol);
        resetAppBtn.addEventListener('click', resetApplication);
        saveProtocolBtn.addEventListener('click', saveProtocol);
        loadProtocolBtn.addEventListener('click', loadProtocol);
        dateInput.addEventListener('input', updateProtocolNameInput); // Listen for date changes
        buildingHeaderInput.addEventListener('input', updateProtocolNameInput); // Listen for building header changes

        // Initial generation of room inputs and populate wiring system select on load
        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            dateInput.value = `${year}-${month}-${day}`;

            populateWiringSystemSelect();
            generateRoomInputs(); // This will create the initial set of room input fields
            updateProtocolNameInput(); // Initial call to set the protocol name
            
            // Initialize Firebase if config is available (for save/load functions)
            initializeFirebase();
        });
    </script>
</body>
</html>
